name: Release Validation

on:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [created, published]
  workflow_dispatch:

jobs:
  full-test-suite:
    name: Full Test Suite (All Builds)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      matrix:
        build-type: [Debug, Release]
        include:
          - build-type: Debug
            service: tests
          - build-type: Release
            service: tests-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test container image
        run: |
          docker-compose -f docker-compose.test.yml build ${{ matrix.service }}

      - name: Run tests (${{ matrix.build-type }})
        run: |
          docker-compose -f docker-compose.test.yml run --rm ${{ matrix.service }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.build-type }}
          path: |
            build-container-*/Testing/
            build-container-*/test-*.log
          retention-days: 30
          if-no-files-found: warn

  coverage-validation:
    name: Coverage Validation
    runs-on: ubuntu-latest
    needs: full-test-suite

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build coverage container
        run: |
          docker-compose -f docker-compose.test.yml build tests-coverage

      - name: Run tests with coverage
        run: |
          docker-compose -f docker-compose.test.yml run --rm tests-coverage

      - name: Extract coverage report
        if: always()
        run: |
          CONTAINER_ID=$(docker ps -a -q -f name=yubikey-oath-tests-coverage | head -1)

          if [ -n "$CONTAINER_ID" ]; then
            mkdir -p coverage-report
            docker cp "${CONTAINER_ID}:/home/testuser/yubikey-oath-krunner/build-container-coverage/coverage_html" ./coverage-report/ || true
            docker cp "${CONTAINER_ID}:/home/testuser/yubikey-oath-krunner/build-container-coverage/coverage_filtered.info" ./coverage-report/ || true
          fi

      - name: Check coverage threshold
        run: |
          if [ -f coverage-report/coverage_filtered.info ]; then
            # Extract line coverage percentage
            COVERAGE=$(lcov --summary coverage-report/coverage_filtered.info 2>&1 | grep "lines" | grep -oP '\d+\.\d+(?=%)')

            echo "Coverage: $COVERAGE%"

            # Threshold: 85%
            THRESHOLD=85.0

            if (( $(echo "$COVERAGE >= $THRESHOLD" | bc -l) )); then
              echo "✅ Coverage ($COVERAGE%) meets threshold ($THRESHOLD%)"
              echo "## Coverage Check ✅" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Coverage: **$COVERAGE%** (threshold: $THRESHOLD%)" >> $GITHUB_STEP_SUMMARY
              exit 0
            else
              echo "❌ Coverage ($COVERAGE%) below threshold ($THRESHOLD%)"
              echo "## Coverage Check ❌" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Coverage: **$COVERAGE%** (threshold: $THRESHOLD%)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "⚠️ Coverage is below the required threshold for release" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "❌ Coverage report not found"
            exit 1
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-release
          path: coverage-report/
          retention-days: 90

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [full-test-suite, coverage-validation]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate release summary
        run: |
          echo "# Release Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.full-test-suite.result }}" == "success" ]; then
            echo "✅ Full test suite: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Full test suite: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.coverage-validation.result }}" == "success" ]; then
            echo "✅ Coverage validation: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Coverage validation: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.full-test-suite.result }}" == "success" ] && \
             [ "${{ needs.coverage-validation.result }}" == "success" ]; then
            echo "## ✅ Release Ready" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All validation checks passed. This release is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Release Blocked" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some validation checks failed. Please review the test results before proceeding." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on Release
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');

            github.rest.repos.createReleaseComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: summary
            });
